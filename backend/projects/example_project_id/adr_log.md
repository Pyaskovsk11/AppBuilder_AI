### `adr_log.md`

# **Architectural Decision Records (ADR) - Журнал Архитектурных Решений**

Этот документ содержит записи о всех ключевых архитектурных решениях, принятых в проекте AppBuilder AI. Каждая запись объясняет контекст проблемы, принятое решение и его последствия. Это делается для того, чтобы новые участники проекта (как люди, так и AI-агенты) могли понять исторические причины текущего состояния архитектуры.

---

### **Шаблон для новых записей**

```markdown
### ADR-XXX: [Название решения]

*   **Статус:** [Proposed | Accepted | Superseded]
*   **Дата:** [YYYY-MM-DD]
*   **Контекст:** [Описание проблемы, ситуации или набора сил, которые привели к необходимости принятия решения. Что мы пытались решить?]
*   **Решение:** [Четкое и конкретное описание принятого решения. Что мы решили сделать?]
*   **Последствия:** [Описание результатов принятого решения.
    *   **Позитивные:** Какие преимущества мы получили?
    *   **Негативные:** Какие компромиссы или новые проблемы это создало? Какие риски мы приняли?]
```

---

### ADR-001: Использование PraisonAI для оркестровки агентов

*   **Статус:** Accepted
*   **Дата:** 2025-08-07
*   **Контекст:** Проекту требуется сложная система для управления жизненным циклом множества AI-агентов, их взаимодействием, передачей контекста и использованием инструментов. Разработка такой системы с нуля является трудоемкой, дорогой и рискованной задачей.
*   **Решение:** Мы приняли решение использовать open-source фреймворк **PraisonAI** в качестве основного движка для оркестровки агентов. Вся логика управления, вызова агентов и использования инструментов будет реализована поверх PraisonAI и его зависимости LangChain.
*   **Последствия:**
    *   **Позитивные:**
        *   Значительное ускорение разработки за счет использования готовой, протестированной инфраструктуры.
        *   Мы остаемся в экосистеме Python, что соответствует основному стеку бэкенда.
        *   Получаем доступ ко всей экосистеме LangChain для интеграции с различными LLM и инструментами.
        *   Декларативное управление агентами через `agents.yaml` упрощает их добавление и модификацию.
    *   **Негативные:**
        *   Проект становится зависимым от дорожной карты и ограничений фреймворка PraisonAI.
        *   Возникает необходимость в глубоком изучении внутреннего устройства PraisonAI для реализации сложных сценариев (например, циклов исправлений с предохранителями).

### ADR-002: Иерархическая стратегия использования LLM

*   **Статус:** Accepted
*   **Дата:** 2025-08-07
*   **Контекст:** Использование одной, самой мощной LLM для всех задач проекта является экономически неэффективным. Многие задачи (например, форматирование, классификация, простая генерация по шаблону) не требуют максимальной мощности, но требуют скорости и низкой стоимости.
*   **Решение:** Мы внедряем **двухуровневую (иерархическую) стратегию** использования моделей Google Gemini:
    1.  **Gemini 1.5 Pro:** Используется для сложных, креативных и аналитических задач: генерация сложного кода, архитектурный анализ, исправление нетривиальных ошибок.
    2.  **Gemini Flash:** Используется для рутинных, структурированных и быстрых задач: классификация запроса, анализ вывода инструментов, форматирование отчетов в JSON, генерация boilerplate-кода.
*   **Последствия:**
    *   **Позитивные:**
        *   Ожидаемое снижение операционных затрат на LLM до 50-70%.
        *   Ускорение выполнения простых этапов workflow за счет использования более быстрой модели.
    *   **Негативные:**
        *   Усложняется логика `Dispatcher`-а и конфигурация в `agents.yaml` (необходимо явно указывать модель для каждого агента).
        *   Появляется риск неверного выбора модели для задачи, что может привести к снижению качества на отдельных этапах.

### ADR-003: Внедрение "Живого Контекста Проекта" (Live Project Context)

*   **Статус:** Accepted
*   **Дата:** 2025-08-07
*   **Контекст:** Передача состояния между агентами через отдельные файлы является хрупкой и плохо масштабируемой. Это приводит к риску работы с устаревшими данными, усложняет аудит и восстановление после сбоев.
*   **Решение:** Мы отказываемся от прямого обмена файлами в пользу централизованной структуры **"Live Project Context"** для каждого проекта. Все агенты взаимодействуют с контекстом (читают и обновляют его) через стандартизированный набор инструментов (`context_manager.py`). Контекст включает спецификацию, журнал решений, статус, задачи и векторный индекс кодовой базы.
*   **Последствия:**
    *   **Позитивные:**
        *   Обеспечивается единый источник правды, что гарантирует согласованность данных для всех агентов.
        *   Упрощается отслеживание истории изменений и аудит процесса генерации.
        *   Появляется возможность для более сложных взаимодействий (агенты могут реагировать на изменение статуса, а не просто ждать своей очереди).
    *   **Негативные:**
        *   Модуль `context_manager.py` становится критически важным компонентом системы (потенциальная точка отказа).
        *   Необходимо реализовать механизм блокировок (locking) для предотвращения одновременной записи в контекст несколькими агентами.

### ADR-004: Использование выделенного инструмента для аудита безопасности

*   **Статус:** Accepted
*   **Дата:** 2025-08-07
*   **Контекст:** Доверять LLM поиск уязвимостей в сгенерированном ею же коде — ненадежно и рискованно ("лиса охраняет курятник"). LLM может пропускать распространенные уязвимости и не обладает экспертизой специализированных инструментов.
*   **Решение:** В цикл контроля качества встраивается **обязательный шаг аудита безопасности** с помощью агента `security-auditor`. Этот агент не использует LLM для анализа, а вызывает через свой "инструмент" (`code_analyzer.py`) статический анализатор **Brakeman**, созданный специально для поиска уязвимостей в приложениях на Ruby on Rails.
*   **Последствия:**
    *   **Позитивные:**
        *   Качество и безопасность сгенерированного кода значительно повышаются за счет использования детерминированного, проверенного инструмента.
        *   Снижается риск генерации приложений с критическими уязвимостями (SQL-инъекции, XSS и т.д.).
    *   **Негативные:**
        *   Увеличивается общее время генерации проекта из-за дополнительного шага анализа.
        *   Системе необходимо научиться обрабатывать вывод Brakeman, включая возможные ложные срабатывания.
        *   Добавляется еще одна внешняя зависимость в окружение для выполнения.